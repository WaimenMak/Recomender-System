<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Movie Recommender System</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<div id="app">
    <el-menu mode="horizontal" default-active="1" background-color="#545c64" text-color="#fff"
        active-text-color="#ffd04b">
        <el-menu-item index="1">Movie Recommender System</el-menu-item>
        <el-menu-item index="2">Algorithm now is : {{this.algoSelect}}</el-menu-item>
    </el-menu>
    <el-container>
        <el-main>

            <!-- tab -->
            <el-tabs v-model="activename" @tab-click="handleClick">

                <!-- RecommendPage -->
                <el-tab-pane label="Recommend Movies" name="first">
                    <el-row :gutter="20">
                      
                        <el-col :span="4" v-for="o in recommended" :key="o.movie_id" :offset="0">
                            <el-card :body-style="{ padding: '0px' }"
                                style="margin-top:15px;height:430px;overflow:auto;position:relative">

                                <el-popover placement="right" title="It is because you have rated this movie...."
                                    width="200" trigger="hover" content="这是一段内容,这是一段内容,这是一段内容,这是一段内容。">

                                    <el-image style="width: 100%;height:240px;" :src="pic_test" fit="cover"></el-image>
                                    <el-image style="width: 100%;height:240px;" :src="o.poster_url" fit="cover"
                                        slot="reference"></el-image>
                                    <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                                    <h6 style="padding:0 10px;margin:0.5em">{{ o.release_date }}</h6>

                                </el-popover>

                                <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                                <h6 style="padding:0 10px;margin:0.5em">{{ o.release_date }}</h6>

                                <div plain style="position:absolute;bottom:5px;left:5px">

                                    <el-rate v-model="o.score" style="padding:10px 10px;"></el-rate>

                                    <el-button type="primary" @click="guess_U_like(o)">
                                        <i class="el-icon-info el-icon--left"></i>Similar movies
                                    </el-button>
                                </div>
                            </el-card>

                        </el-col>
                        
                    </el-row>

                    <el-button type="danger" @click="update">
                        <i class="el-icon-info el-icon--left"></i>Update
                    </el-button>
                </el-tab-pane>

                <!-- userProfile -->
                <el-tab-pane label="Rated Movies" name="second">
                    <el-row :gutter="20">
                        <el-col :span="4" v-for="o in user_profile" :key="o.movie_id" :offset="0">
                            <el-card :body-style="{ padding: '0px' }"
                                style="margin-top:15px;height:450px;overflow:auto;position:relative">
                                <el-image style="width: 100%;height:240px;" :src="o.poster_url" fit="cover"></el-image>
                                <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                                <h6 style="padding:0 10px;margin:0.5em">{{ o.release_date }}</h6>
                                <el-rate v-model="o.score" style="padding:10px 10px;"></el-rate>
                                <el-button type="danger" @click="o.score=0">
                                    <i class="el-icon-info el-icon--left"></i>remove
                                </el-button>
                                <!-- // focus -->
                                <el-button type="primary" @click="guess_U_like(o)">
                                    <i class="el-icon-info el-icon--left"></i>Similar movies
                                </el-button>
                            </el-card>
                        </el-col>
                    </el-row>

                    <el-button type="danger" @click="update_profile">
                        <i class="el-icon-info el-icon--left"></i>Update
                    </el-button>

                </el-tab-pane>

                <!-- Test area -->
                <el-tab-pane label="DataTestArea" name="third">

                    <!-- == == == == == ==== == ==== == ==== == ==== == ==== == ==== == ==-->

                    <!-- focus -->
                    <el-table :data="recommended" style="width: 100%">
                        <el-table-column prop="movie_id" label="movie_id" width="180">
                        </el-table-column>
                        <el-table-column prop="movie_title" label="movie_title" width="180">
                        </el-table-column>
                        <el-table-column prop="poster_url" label="poster_url">
                        </el-table-column>
                        <el-table-column prop="score" label="score">
                        </el-table-column>
                    </el-table>

                    <!-- == == == == == ==== == ==== == ==== == ==== == ==== == ==== == ==-->
                </el-tab-pane>

            </el-tabs>
            <!-- tab -->


            <!-- guess you like -->
            <el-drawer title="Guess you may like these movies...." :visible.sync="drawer" direction="btt">

                <el-row :gutter="20">
                    <el-col :span="2">
                    </el-col>
                    <el-col :span="4" v-for="o in guess_like" :key="o.movie_id" :offset="0">
                        <el-image style="width: 100%;height:240px;" :src="o.poster_url" fit="cover"></el-image>
                        <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                        <h6 style="padding:0 10px;margin:0.5em">{{ o.release_date }}</h6>
                    </el-col>
                    <el-col :span="2">
                    </el-col>
                </el-row>

            </el-drawer>




            <!--  Dialog0-->
            <el-dialog title="Please choose any genre you're interested in." :visible="dialog0" width="60%"
                :show-close="false">

                <el-steps :active=0 finish-status="success">
                    <el-step title="Step 1"></el-step>
                    <el-step title="Step 2"></el-step>
                    <el-step title="Get your recommend!"></el-step>
                </el-steps>

                <span>Multiple answers are possible.</span>
                <el-checkbox-group v-model="selected_genre" style="margin-top:20px">
                    <el-checkbox :label=item border v-for="(item, index) in genre" :key="index"
                        style="margin-top:20px; margin-left: 0px"></el-checkbox>
                </el-checkbox-group>

                <span slot="footer" class="dialog-footer">
                    <!-- The selected box for algorithm -->
                    <el-radio-group v-model="algoSelect">
                        <el-radio-button label="0">algo-0</el-radio-button>
                        <el-radio-button label="1">algo-1</el-radio-button>
                    </el-radio-group>
                    <el-button type="danger" @click="step1" plain :disabled="step1_show" style="min-width:128px">Next
                    </el-button>
                </span>
            </el-dialog>

            <!--  Dialog1-->
            <el-dialog title="Please rate the following movies." :visible="dialog1" width="80%" :show-close="false">
                <el-row :gutter="20">

                    <el-steps :active=1 finish-status="success">
                        <el-step title="Step 1"></el-step>
                        <el-step title="Step 2"></el-step>
                        <el-step title="Get your recommend!"></el-step>
                    </el-steps>

                    <el-col :span="4" v-for="o in movies" :key="o.movie_id" :offset="0">
                        <el-card :body-style="{ padding: '0px' }" style="margin-top:15px;height:368px;overflow:auto">
                            <el-image style="width: 100%;height:240px;" :src="o.poster_url" fit="cover"></el-image>
                            <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                            <el-rate v-model="o.score" style="padding:10px 10px;"></el-rate>
                        </el-card>
                    </el-col>
                </el-row>

                <span slot="footer" class="dialog-footer">
                    <el-button type="danger" @click="refresh" style="width:128px">
                        refresh
                    </el-button>
                    <el-button type="danger" @click="step2" plain :disabled="step2_show" style="width:128px">Next
                    </el-button>
                </span>
            </el-dialog>
        </el-main>

    </el-container>
</div>

<body>
    <!-- import Vue before Element -->
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/en.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>

        ELEMENT.locale(ELEMENT.lang.en)
        new Vue({
            el: '#app',
            data: function () {
                return {

                    baseurl: 'http://127.0.0.1:8000',
                    genre: [],
                    selected_genre: [],
                    algoSelect: 0,
                    movies: [],
                    selected_movies: [],
                    user_profile: [],
                    recommended: [],
                    guess_like: [],
                    dialog0: true,
                    dialog1: false,
                    iconClasses: ['icon-rate-face-1', 'icon-rate-face-2', 'icon-rate-face-3'],
                    value: 2,
                    test:[],
                    drawer: false,
                    pic_test: "https://miro.medium.com/max/5728/1*jrGtIJOcp12u53T6r5VuIA.jpeg",
                    activename: "first",
                }
            },

            methods: {

                //=============== testmethod ===============



                //=============== testmethod ===============

                update_profile: function () {
                    axios.post(this.baseurl + "/api/profile", this.user_profile).then((res) => {
                        this.user_profile = res.data;
                    });
                },


                update: function () {

                    this.selected_movies = this.selected_movies.concat(this.recommended);

                    axios.post(this.baseurl + "/api/profile", this.selected_movies).then((res) => {
                        this.user_profile = res.data;
                        this.selected_movies = this.user_profile;
                        axios.post(this.baseurl + "/api/recommend", this.user_profile).then((res) => {
                            this.recommended = res.data;
                        });
                    });

                },
                refresh: function () {

                    this.selected_movies = this.selected_movies.concat(this.movies);

                    axios.post(this.baseurl + "/api/refresh", this.selected_genre).then((res) => {

                        this.movies = res.data;
                        this.dialog0 = false;
                        this.dialog1 = true;

                    })
                },

                step1: function () {
                    step1_value = [];
                    step1_value.push(this.selected_genre);
                    step1_value.push(this.algoSelect);
                    axios.post(this.baseurl + "/api/movies", step1_value).then((res) => {

                        this.movies = res.data;
                        this.dialog0 = false;
                        this.dialog1 = true;
             
                    })
                },

                step2: function () {

                    this.selected_movies = this.selected_movies.concat(this.movies);

                    axios.post(this.baseurl + "/api/profile", this.selected_movies).then((res) => {
                        this.user_profile = res.data;
                        axios.post(this.baseurl + "/api/recommend", this.user_profile).then((res) => {
                            this.recommended = res.data;
                            this.dialog1 = false;
                        
                        });
                    });
                },

                liked_btn: function (movie) {
                    let that = this;
                    this.liked.push(movie);
                    this.recommended.splice(this.recommended.findIndex(item => item.movie_id === movie.movie_id), 1);
                    axios.get(this.baseurl + '/api/add_recommend/' + movie.movie_id).then((res) => {
                        console.log(res.data);
                        that.recommended.push.apply(that.recommended, res.data);
                        that.liked.push.apply(that.liked, res.data);
                    })
                },

                // focus
                guess_U_like: function (movie) {
                    axios.get(this.baseurl + '/api/guesslike/' + movie.movie_id).then((res) => {
                        this.drawer = true;
                        this.guess_like = res.data;
                    })
                }

            },
            mounted: function () {
                axios.get(this.baseurl + "/api/genre").then((res) => {
                    this.genre = res.data['genre'];
                })
            },
            computed: {
                step1_show: function () {
                    if (this.selected_genre.length > 0) {
                        return false;
                    } else {
                        return true;
                    }
                },
                step2_show: function () {
                    let scores = 0;
                    for (let i of this.movies) {
                        if (i['score'] > 0) {
                            scores++
                        }
                    }
                    console.log(scores);
                    if (scores >= 1) {
                        return false;
                    } else {
                        return true
                    }
                },
            }
        })
    </script>
</body>

</html>